<!DOCTYPE html>
<html>
<head>
  <% include ../partials/header.ejs %>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/masonry/4.2.2/masonry.pkgd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-infinitescroll/3.0.5/infinite-scroll.pkgd.min.js"></script>
  <link rel="stylesheet" type="text/css" href="/stylesheets/render.css" />
  <link rel="stylesheet" type="text/css" href="/stylesheets/dashboard.css" />
</head>

<body>
  <% include ../partials/navbar.ejs %>
  <% include ../partials/masthead.ejs %>

  <div class="container">
    <div class="row">
      <div class="col" id="news-top"></div>
    </div>
  </div>

  <div class="container">
    <div id="back-to-dash-button" class="row mb-3 text-center collapse">
      <div class="col">
        <a href="/dashboard"><button type="button" class="btn btn-sm btn-primary">
          <span class='oi oi-home' title='Back to Dashboard' aria-hidden='true'></span>
          Back to Dashboard
        </button></a>
      </div>
    </div>

    <div class="row mb-5">
      <div class="col"></div>
      <div class="col-md-6 text-center">
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#create-post-modal">
          <span class='oi oi-pencil' title='New post' aria-hidden='true'></span>
          New post
        </button>
        <a href="/posts"><button type="button" class="btn btn-sm btn-secondary" id="posts-page-button">
          <span class='oi oi-book' title='My posts' aria-hidden='true'></span>
          My posts
        </button></a>
        <a href="/settings"><button type="button" class="btn btn-sm btn-secondary" id="settings-page-button">
          <span class='oi oi-cog' title='Settings' aria-hidden='true'></span>
          Settings
        </button></a>
      </div>
      <div class="col"></div>
    </div>

    <div class="row">
      <div class="col" id="news-left"></div>
      <div class="col-md-6">
        <div id="posts" class="grid">
          <div class="grid-sizer col-md-12"></div>
        </div>
      </div><!--col-->
      <div class="col" id="news-right"></div>
    </div><!--row-->

    <div id="posts-button" class="collapse text-center">
      <div class="button more-button">more</div>
    </div>

    <div id="posts-template" class="d-none">
      <div class="grid-item col-md-12">
      <div class="card mb-4">
        <a class="card-img-fold-link" href="#"><span class="fold"></span></a>
        <div>
        <a class="card-author-link" href="#"><div class="d-inline-block mx-1 my-2 card-author-avatar"></div></a>
        <a class="card-author-post-link small py-2" href="#"><div class="d-inline-block card-author"></div></a>
        </div>
        <a class="card-img-top-link" href="#"><img class="card-img-top" src=""/></a>
        <div class="card-body">
          <a class="card-title-link" href="#"><h5 class="card-title"></h5></a>
          <p class="card-text"></p>
        </div>
      </div><!--card-->
      </div><!--grid-item-->
    </div><!--posts-template-->
  </div><!--container-->

  <div class="modal fade" tabindex="-1" role="dialog" id="create-post-modal">
    <div class="modal-dialog" role="document"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">New post</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div><!--header-->
      <div class="modal-body"><form id="create-post-form" data-mode="new">
        <div class="form-group">
          <input type="text" class="form-control form-post-title" 
            value="" placeholder="Title" autofocus />
          <input type="text" class="form-control form-post-thumb" 
            value="" placeholder="Image" />
          <input type="text" class="form-control form-post-url" 
            value="" placeholder="URL" />
          <input type="hidden" class="form-control form-post-reblog-url" 
            value="">
          <textarea class="form-control form-post-text" rows="5" placeholder="Text"></textarea>
          <input type="text" class="form-control form-post-tags" 
            value="" placeholder="Tags" />
        </div>
      </form></div><!--body-->
      <div id="create-post-success-alert" 
        class="alert alert-success collapse" role="alert">Post saved!</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" 
          id="create-post-save-button">
          <span class='oi oi-pencil' title='Save' aria-hidden='true'></span>
          Save
        </button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div><!--footer-->
    </div></div><!--document-->
  </div><!--modal-->

  <div class="modal fade" tabindex="-1" role="dialog" id="follow-modal">
    <div class="modal-dialog" role="document"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Follow new blog</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div><!--header-->
      <div class="modal-body"><form id="follow-form">
        <div class="form-group">
          <input type="text" class="form-control form-follow-url" 
            value="" placeholder="Blog URL">
        </div>
      </form></div><!--body-->
      <div id="follow-success-alert" 
        class="alert alert-success collapse" role="alert">Follow success!</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" 
          id="follow-save-button">
          <span class='oi oi-plus' title='Follow' aria-hidden='true'></span>
          Follow
        </button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div><!--footer-->
    </div></div><!--document-->
  </div><!--modal-->

  <div class="modal fade" tabindex="-1" role="dialog" id="unfollow-modal">
    <div class="modal-dialog" role="document"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Unfollow blog</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div><!--header-->
      <div class="modal-body"><form id="unfollow-form">
        <div class="form-group">
          <input type="text" class="form-control form-unfollow-url" 
            value="" placeholder="Blog URL">
        </div>
      </form></div><!--body-->
      <div id="unfollow-success-alert" 
        class="alert alert-success collapse" role="alert">Unfollow success!</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" 
          id="unfollow-save-button">
          <span class='oi oi-minus' title='Unfollow' aria-hidden='true'></span>
          Unfollow
        </button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div><!--footer-->
    </div></div><!--document-->
  </div><!--modal-->

  <div id="no-posts-message" class="mt-3 text-center collapse">
    <img id="center-logo" src="/media/logoLight.png" class="mb-3"/>
    <div>No posts yet</div>
  </div>

  <div id="no-follows-message" class="mt-3 text-center collapse">
    <img id="center-logo" src="/media/logoLight.png" class="mb-3"/>
    <div>Nothing to see in your feed yet</div>
    <div>Please follow more blogs</div>
  </div>

  <% include ../partials/footer.ejs %>

  <script>
    <% include ../partials/dashboard.ejs %>
    <% include ../partials/render_feed.ejs %>
    <% include ../partials/news.ejs %>

    var dash = new Dashboard({
      "postSelector": "#create-post",
      "followSelector": "#follow",
      "unfollowSelector": "#unfollow"
    });

    $.getJSON("<%= render_uris[0] %>", function(data) {
      <%if (render_uris.length == 1) {%>
      if (data.style_url)
        addCss(data.style_url);
      <% } %>
    });  

    var renderer = new RenderFeed({
      "uris": <%- JSON.stringify(render_uris) %>,
      "selector": "#posts",
      "onNoPosts": function() {
        if (window.location.href.indexOf("dashboard") != -1)
          $("#no-follows-message").show();          
        else
          $("#no-posts-message").show();          
      }
    });

    var news = new News({
      "url": "<%= MASTER_NEWS %>",
      //"url": "http://localhost:5000/news_test.json", // ANDBG
      "selector": "#news",
      "page": "dashboard"
    });

    function addCss(cssPath) {
      var stylesheet = document.createElement("link");
      stylesheet.href=cssPath;
      stylesheet.rel="stylesheet";
      stylesheet.type = 'text/css';
      document.getElementsByTagName("head")[0].appendChild(stylesheet);
      window.___gcfg={parsetags:'onload'};
    }

    
    if (window.location.href.indexOf("posts") != -1)
      $("#back-to-dash-button").show();

    console.log(JSON.stringify(new Date()));
  </script>
</body>
</html>
