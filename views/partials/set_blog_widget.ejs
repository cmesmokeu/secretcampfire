<div class="modal fade" tabindex="-1" role="dialog" id="set-blog-modal">
  <div class="modal-dialog" role="document"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">Enter your <b><%= SITE_NAME %></b> blog URL</h5>
      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div><!--header-->
    <div class="modal-body"><form id="set-blog-form">
      <div class="form-group">
        <input type="text" class="form-control form-blog-url" 
          value="" placeholder="Your blog URL">
        <p class='text-right small mt-2'><a href="<%= MASTER_URL %>">Don't have a <b><%= SITE_NAME %></b> blog yet? Get yours here</a></p>
      </div>
    </form></div><!--body-->
    <div id="set-blog-success-alert" 
      class="alert alert-success collapse" role="alert">Saved!</div>
    <div class="modal-footer">
      <button type="button" class="btn btn-primary" 
        id="set-blog-save-button">Save</button>
      <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
    </div><!--footer-->
  </div></div><!--document-->
</div><!--modal-->

<script>
function SetBlogWidget(cfg) {
  this.selector = cfg.selector 
  this.sessionDatastore = cfg.sessionDatastore;

  this._datastoreKey = 'blog_url';
  this._callAfterBlogSet = null;

  this.init();
}
SetBlogWidget.prototype.init = function() {
  var sbw = this;
  $(this.selector+"-save-button").click(function(e) {
    e.preventDefault();
    sbw.handleSave();
    return false;
  });

  $(this.selector+"-form .form-blog-url").on('keypress', function(e) {
    if (e.which === 13)
    {
      e.preventDefault();
      $(this).attr("disabled", "disabled");
      sbw.handleSave();
      $(this).removeAttr("disabled");
      return false;
    }
  });
}
SetBlogWidget.prototype.handleSave = function() {
  var val = $(this.selector + "-form .form-blog-url").val();
  if (!val)
    return false;

  this.sessionDatastore.setData(this._datastoreKey, val);
  if (this._callAfterBlogSet)
  {
    var cb = this._callAfterBlogSet;
    this._callAfterBlogSet = null;
    $("#set-blog-modal").modal("hide");
    cb(val);
  }
}
SetBlogWidget.prototype.getBlog = function(cb) {
  var sb = this;
  this.sessionDatastore.getData(this._datastoreKey, function(url) {
    console.log("getBlog: " + url);
    if (url)
    {
      // blog URL already set
      console.log("[SetBlogWidget] blog set: " + url);
      cb(url);
      return;
    }

    sb._callAfterBlogSet = cb;
    $("#set-blog-modal").modal("show");
  });
}

var g_setBlogWidget = new SetBlogWidget({
  selector: '#set-blog',
  sessionDatastore: g_sessionDatastore
});
</script>
